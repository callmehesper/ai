<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crypto Market Predictor</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0f0f0f; color: #fff; text-align: center; padding: 30px; }
        input, button, select { font-size: 16px; padding: 8px; margin: 10px; border-radius: 8px; border: none; }
        .toggle { padding: 8px 16px; margin: 10px; border-radius: 8px; background: #1a1a1a; color: white; cursor: pointer; }
        .active { background: #00b894; }
        #result { font-size: 1.5em; margin-top: 30px; }
        #priceBox { margin-top: 15px; font-size: 0.9em; line-height: 1.6; }
        .suggestions { background: #1f1f1f; border-radius: 10px; max-width: 200px; margin: auto; position: absolute; left: 50%; transform: translateX(-50%); z-index: 999; }
        .suggestions div { padding: 8px; border-bottom: 1px solid #333; cursor: pointer; }
        .suggestions div:hover { background: #333; }
        #chart-container { width: 100%; max-width: 1000px; height: 500px; margin: 30px auto; }
        footer { margin-top: 40px; font-size: 0.8em; color: #888; }
        .disclaimer { margin-top: 20px; font-size: 0.8em; color: #f9ca24; }
    </style>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
    <h1>🔮 AI Crypto Market Predictor</h1>

    <label for="coin">Search Coin (e.g., BTCUSDT):</label><br>
    <input type="text" id="coin" oninput="showSuggestions(); fetchSignal();" autocomplete="off" placeholder="Start typing...">
    <div id="suggestions" class="suggestions"></div>

    <div>
        <button class="toggle active" onclick="setMode('spot')" id="spotBtn">Spot</button>
        <button class="toggle" onclick="setMode('futures')" id="futuresBtn">Futures (Beta)</button>
    </div>

    <div id="result">📱 Waiting for data...</div>
    <div id="priceBox"></div>
    <div id="chart-container"><div id="tv_chart"></div></div>

    <div class="disclaimer">
        **Disclaimer:** These signals are generated by an AI based on technical analysis and should not be considered financial advice. Backtesting results may not reflect future performance. Trade at your own risk.
    </div>

    <footer>
        &copy; 2025 All rights reserved to Hesper
    </footer>

    <script>
        let mode = 'spot';
        let allCoins = [];

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('spotBtn').classList.remove('active');
            document.getElementById('futuresBtn').classList.remove('active');
            document.getElementById(newMode + 'Btn').classList.add('active');
            fetchSignal();
        }

        async function loadCoinList() {
            try {
                const res = await fetch("https://api.binance.com/api/v3/exchangeInfo");
                const data = await res.json();
                allCoins = data.symbols
                    .filter(s => s.symbol.endsWith("USDT") && s.status === "TRADING")
                    .map(s => s.symbol);
            } catch (e) {
                console.error("Failed to load coin list", e);
            }
        }

        function showSuggestions() {
            const input = document.getElementById('coin').value.toUpperCase();
            const suggestionBox = document.getElementById('suggestions');
            suggestionBox.innerHTML = '';
            if (!input || input.length < 1) return;

            const matches = allCoins.filter(c => c.includes(input)).slice(0, 10);
            matches.forEach(coin => {
                const div = document.createElement('div');
                div.textContent = coin;
                div.onclick = () => {
                    document.getElementById('coin').value = coin;
                    suggestionBox.innerHTML = '';
                    fetchSignal();
                };
                suggestionBox.appendChild(div);
            });
        }

        async function getKlines(symbol, interval) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=100`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Binance API Error for ${symbol} (${interval}): ${res.status} - ${res.statusText}`);
            const data = await res.json();
            return data.map(c => ({
                time: c[0],
                open: parseFloat(c[1]),
                high: parseFloat(c[2]),
                low: parseFloat(c[3]),
                close: parseFloat(c[4]),
                volume: parseFloat(c[5])
            }));
        }

        function calculateEMA(prices, period) {
            const k = 2 / (period + 1);
            let ema = prices[0];
            for (let i = 1; i < prices.length; i++) {
                ema = (prices[i] * k) + (ema * (1 - k));
            }
            return ema;
        }

        function calculateRSI(prices, period) {
            let gains = 0;
            let losses = 0;
            for (let i = 1; i < period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) {
                    gains += change;
                } else {
                    losses -= change;
                }
            }
            const averageGain = gains / period;
            const averageLoss = losses / period;
            const rs = averageGain / averageLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateMACD(prices, fastLength, slowLength, signalLength) {
            const fastEMA = calculateEMA(prices, fastLength);
            const slowEMA = calculateEMA(prices, slowLength);
            const macdLine = fastEMA - slowEMA;
            const signalLine = calculateEMA([macdLine], signalLength);
            return { macd: macdLine, signal: signalLine };
        }

        function calculateBollingerBands(prices, period) {
            const sma = prices.slice(-period).reduce((sum, p) => sum + p, 0) / period;
            const stdDev = Math.sqrt(prices.slice(-period).reduce((sum, p) => sum + Math.pow(p - sma, 2), 0) / period);
            return { upper: sma + 2 * stdDev, lower: sma - 2 * stdDev };
        }

        async function fetchSignal() {
            const symbol = document.getElementById('coin').value.trim().toUpperCase();
            if (!symbol || symbol.length < 6) return;

            document.getElementById('result').innerText = `⏳ Analyzing ${symbol}...`;
            document.getElementById('priceBox').innerText = "";

            try {
                const candles1h = await getKlines(symbol, '1h');
                const candles15m = await getKlines(symbol, '15m');

                const indicators1h = calculateIndicators(candles1h);
                const indicators15m = calculateIndicators(candles15m);

                const lastPrice = candles1h[candles1h.length - 1].close;
                const target = (lastPrice * 1.03).toFixed(2);
                const stopLoss = (lastPrice * 0.985).toFixed(2);

                // --- 1-Hour Signal Logic ---
                let signal1h = '';
                let confidence1h = 0;
                if (indicators1h.ema50 > indicators1h.ema200) confidence1h++;
                if (indicators1h.rsi < 30) confidence1h++;
                if (indicators1h.macd.macd > indicators1h.macd.signal) confidence1h++;
                if (candles1h[candles1h.length - 1].close < indicators1h.bollingerBands.lower) confidence1h++;

                if (confidence1h >= 3) signal1h = 'Buy';
                else if (indicators1h.ema50 < indicators1h.ema200 && indicators1h.rsi > 70 && indicators1h.macd.macd < indicators1h.macd.signal && candles1h[candles1h.length - 1].close > indicators1h.bollingerBands.upper) signal1h = 'Sell';
                else if (indicators1h.ema50 < indicators1h.ema200 && indicators1h.rsi > 70 && indicators1h.macd.macd < indicators1h.macd.signal) signal1h = 'Sell';
                else if (indicators1h.ema50 < indicators1h.ema200 && indicators1h.rsi > 70) signal1h = 'Weak Sell';
                else if (indicators1h.ema50 > indicators1h.ema200 && indicators1h.rsi < 30) signal1h = 'Weak Buy';
                else signal1h = 'Neutral';
                const confidenceText1h = confidence1h >= 3 ? 'High' : confidence1h >= 2 ? 'Moderate' : 'Low';

                // --- 15-Minute Signal Logic ---
                let signal15m = '';
                let confidence15m = 0;
                if (indicators15m.ema50 > indicators15m.ema200) confidence15m++;
                if (indicators15m.rsi < 30) confidence15m++;
                if (indicators15m.macd.macd > indicators15m.macd.signal) confidence15m++;
                if (candles15m[candles15m.length - 1].close < indicators15m.bollingerBands.lower) confidence15m++;

                if (confidence15m >= 3) signal15m = 'Buy';
                else if (indicators15m.ema50 < indicators15m.ema200 && indicators15m.rsi > 70 && indicators15m.macd.macd < indicators15m.macd.signal && candles15m[candles15m.length - 1].close > indicators15m.bollingerBands.upper) signal15m = 'Sell';
                else if (indicators15m.ema50 < indicators15m.ema200 && indicators15m.rsi > 70 && indicators15m.macd.macd < indicators15m.macd.signal) signal15m = 'Sell';
                else if (indicators15m.ema50 < indicators15m.ema200 && indicators15m.rsi > 70) signal15m = 'Weak Sell';
                else if (indicators15m.ema50 > indicators15m.ema200 && indicators15m.rsi < 30) signal15m = 'Weak Buy';
                else signal15m = 'Neutral';
                const confidenceText15m = confidence15m >= 3 ? 'High' : confidence15m >= 2 ? 'Moderate' : 'Low';


                document.getElementById('result').innerText = `📊 Signals for ${symbol}`;
                document.getElementById('priceBox').innerHTML = `
                    <strong>1-Hour Timeframe:</strong><br>
                    Signal: <span style="color: ${signal1h.includes('Buy') ? 'green' : signal1h.includes('Sell') ? 'red' : 'white'};">${signal1h}</span> (Confidence: ${confidenceText1h})<br>
                    EMA (50): ${indicators1h.ema50 ? indicators1h.ema50.toFixed(2) : 'N/A'}, EMA (200): ${indicators1h.ema200 ? indicators1h.ema200.toFixed(2) : 'N/A'}<br>
                    RSI (14): ${indicators1h.rsi ? indicators1h.rsi.toFixed(2) : 'N/A'}, MACD (MACD: ${indicators1h.macd.macd ? indicators1h.macd.macd.toFixed(2) : 'N/A'}, Signal: ${indicators1h.macd.signal ? indicators1h.macd.signal.toFixed(2) : 'N/A'})<br>
                    Bollinger Bands (Upper: ${indicators1h.bollingerBands.upper ? indicators1h.bollingerBands.upper.toFixed(2) : 'N/A'}, Lower: ${indicators1h.bollingerBands.lower ? indicators1h.bollingerBands.lower.toFixed(2) : 'N/A'})<br><br>

                    <strong>15-Minute Timeframe:</strong><br>
                    Signal: <span style="color: ${signal15m.includes('Buy') ? 'green' : signal15m.includes('Sell') ? 'red' : 'white'};">${signal15m}</span> (Confidence: ${confidenceText15m})<br>
                    EMA (50): ${indicators15m.ema50 ? indicators15m.ema50.toFixed(2) : 'N/A'}, EMA (200): ${indicators15m.ema200 ? indicators15m.ema200.toFixed(2) : 'N/A'}<br>
                    RSI (14): ${indicators15m.rsi ? indicators15m.rsi.toFixed(2) : 'N/A'}, MACD (MACD: ${indicators15m.macd.macd ? indicators15m.macd.macd.toFixed(2) : 'N/A'}, Signal: ${indicators15m.macd.signal ? indicators15m.macd.signal.toFixed(2) : 'N/A'})<br>
                    Bollinger Bands (Upper: ${indicators15m.bollingerBands.upper ? indicators15m.bollingerBands.upper.toFixed(2) : 'N/A'}, Lower: ${indicators15m.bollingerBands.lower ? indicators15m.bollingerBands.lower.toFixed(2) : 'N/A'})<br><br>

                    Current Price: $${lastPrice}<br>
                    Potential Target (1-Hour): $${target}<br>
                    Potential Stop-Loss (1-Hour): $${stopLoss}<br>
                `;

                loadChart(symbol);
            } catch (e) {
                document.getElementById('result').innerText = "❌ Invalid coin or network error";
                document.getElementById('priceBox').innerText = "";
                console.error("Error fetching or processing data:", e); // Log the full error
            }
        }

        function loadChart(symbol) {
            new TradingView.widget({
                width: "100%",
                height: 500,
                symbol: "BINANCE:" + symbol,
                interval: "60", // Default to 1-hour chart
                timezone: "Etc/UTC",
                theme: "dark",
                style: "1",
                locale: "en",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_legend: false,
                save_image: false,
                container_id: "tv_chart"
            });
        }

        window.onload = loadCoinList;
    </script>
</body>
</html>